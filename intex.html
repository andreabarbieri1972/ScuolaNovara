<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sito Gruppo - Docs & Calendar</title>

  <!-- FullCalendar CSS (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6/main.min.css" rel="stylesheet"/>

  <!-- CSS base rapido -->
  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --accent:#2563eb; --muted:#6b7280;
      --radius:12px; --gap:18px;
    }
    *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
    body{margin:0;background:var(--bg);color:#111;padding:24px;}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px;}
    h1{font-size:1.25rem;margin:0}
    .container{display:grid;grid-template-columns:1fr 360px;gap:var(--gap);align-items:start;}
    @media (max-width:900px){ .container{grid-template-columns:1fr} }
    .card{background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:0 6px 18px rgba(15,23,42,0.06);}
    .small{font-size:0.9rem;color:var(--muted)}
    /* file list */
    .files li{margin:8px 0;display:flex;justify-content:space-between;gap:8px}
    .btn{background:var(--accent);color:white;border:none;padding:8px 10px;border-radius:8px;cursor:pointer}
    .btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(37,99,235,0.12)}
    /* calendar */
    #calendar{max-width:100%;margin-top:12px}
    /* links */
    .links-list{display:flex;flex-direction:column;gap:8px}
    .link-item{padding:8px;border-radius:8px;background:#f8fafc}
  </style>
</head>
<body>
  <header>
    <h1>Sito Gruppo â€” Documenti, Calendario & Link</h1>
    <div class="small">Condivisione semplice per il tuo gruppo</div>
  </header>

  <div class="container">
    <!-- LEFT: principale -->
    <div>
      <!-- Upload -->
      <div class="card" id="uploadCard">
        <h3>Carica documento</h3>
        <p class="small">PDF, immagini, note (max size controllato dal servizio)</p>
        <form id="uploadForm">
          <input id="fileInput" type="file" required />
          <div style="height:12px"></div>
          <button class="btn" type="submit">Carica</button>
          <div id="uploadMsg" class="small" style="margin-top:8px"></div>
        </form>

        <hr style="margin:12px 0">

        <h4>Documenti</h4>
        <ul id="fileList" class="files small"></ul>
      </div>

      <!-- Calendar -->
      <div class="card" style="margin-top:16px">
        <h3>Calendario condiviso</h3>
        <div id="calendar"></div>

        <hr style="margin:12px 0">
        <form id="eventForm" class="small">
          <input id="title" placeholder="Titolo evento" required />
          <input id="start" type="datetime-local" required />
          <input id="end" type="datetime-local" />
          <div style="height:8px"></div>
          <button class="btn" type="submit">Aggiungi evento</button>
        </form>
      </div>
    </div>

    <!-- RIGHT: sidebar -->
    <aside>
      <div class="card">
        <h4>Link utili</h4>
        <div id="linksContainer" class="links-list small"></div>
      </div>

      <div class="card" style="margin-top:16px">
        <h4>Note</h4>
        <p class="small">Per usare questo demo: crea progetto Supabase e sostituisci le costanti SUPABASE_URL/SUPABASE_KEY nel codice sottostante.</p>
      </div>
    </aside>
  </div>

  <!-- FullCalendar + Supabase SDK (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6/main.min.js"></script>
  <script type="module">
    // IMPORT Supabase come module (CDN +esm)
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    // ========== CONFIG: metti qui i tuoi valori ==========
    const SUPABASE_URL = 'https://YOUR-PROJECT.supabase.co'
    const SUPABASE_ANON = 'YOUR-ANON-KEY'
    // =====================================================

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON)

    // ---------- FILE UPLOAD ----------
    const uploadForm = document.getElementById('uploadForm')
    const fileInput = document.getElementById('fileInput')
    const uploadMsg = document.getElementById('uploadMsg')
    const fileList = document.getElementById('fileList')

    async function listFiles(){
      fileList.innerHTML = '<li class="small">Caricamento...</li>'
      const { data, error } = await supabase.storage.from('documents').list('', { limit: 200 })
      if(error){ fileList.innerHTML = '<li class="small">Errore nel listing</li>'; console.error(error); return }
      if(!data || data.length===0){ fileList.innerHTML = '<li class="small">Nessun file</li>'; return }
      fileList.innerHTML = ''
      data.forEach(f=>{
        const li = document.createElement('li')
        const a = document.createElement('a')
        // public URL (se bucket pubblico)
        const { data: pub } = supabase.storage.from('documents').getPublicUrl(f.name)
        a.href = pub.publicUrl
        a.textContent = f.name
        a.target = '_blank'
        li.appendChild(a)
        const del = document.createElement('button')
        del.className = 'btn ghost'
        del.textContent = 'Elimina'
        del.onclick = async ()=>{
          await supabase.storage.from('documents').remove([f.name])
          listFiles()
        }
        li.appendChild(del)
        fileList.appendChild(li)
      })
    }

    uploadForm.addEventListener('submit', async (e)=>{
      e.preventDefault()
      const file = fileInput.files[0]
      if(!file){ uploadMsg.textContent = 'Seleziona un file'; return }
      uploadMsg.textContent = 'Caricamento in corso...'
      const path = `${Date.now()}_${file.name}`
      const { data, error } = await supabase.storage.from('documents').upload(path, file)
      if(error){ uploadMsg.textContent = 'Errore: '+error.message; console.error(error); return }
      uploadMsg.textContent = 'Caricato!'
      fileInput.value = ''
      listFiles()
    })

    // ---------- CALENDAR ----------
    let calendar
    async function initCalendar(){
      const calendarEl = document.getElementById('calendar')
      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        selectable: true,
        headerToolbar: { left:'prev,next today', center:'title', right:'dayGridMonth,timeGridWeek,listWeek' },
      })
      calendar.render()
      await loadEventsIntoCalendar()
    }

    async function loadEventsIntoCalendar(){
      const { data, error } = await supabase.from('events').select('*').order('start', {ascending:true})
      if(error){ console.error(error); return }
      calendar.removeAllEvents()
      data.forEach(ev=>{
        calendar.addEvent({ id:ev.id, title:ev.title, start:ev.start, end:ev.end })
      })
    }

    document.getElementById('eventForm').addEventListener('submit', async (e)=>{
      e.preventDefault()
      const title = document.getElementById('title').value
      const start = document.getElementById('start').value
      const end = document.getElementById('end').value || null
      if(!title || !start) return
      const { data, error } = await supabase.from('events').insert([{ title, start, end }]).select()
      if(error){ console.error(error); return }
      // aggiungi al calendario e svuota form
      calendar.addEvent({ id:data[0].id, title:data[0].title, start:data[0].start, end:data[0].end })
      document.getElementById('title').value = ''
      document.getElementById('start').value = ''
      document.getElementById('end').value = ''
    })

    // ---------- LINKS (static JSON -> potresti anche usare un file links.json) ----------
    const links = {
      "Generale":[
        { "title":"WhatsApp Gruppo","url":"https://chat.whatsapp.com/..." },
        { "title":"Regole della casa","url":"https://example.com/rules" }
      ],
      "Eventi":[
        { "title":"Prenotazioni","url":"https://example.com/book" }
      ]
    }
    function renderLinks(){
      const container = document.getElementById('linksContainer')
      container.innerHTML = ''
      Object.entries(links).forEach(([cat, arr])=>{
        const h = document.createElement('div'); h.textContent = cat; h.style.fontWeight='600'; container.appendChild(h)
        arr.forEach(l=>{
          const a = document.createElement('a'); a.href=l.url; a.textContent=l.title; a.target='_blank'
          const d = document.createElement('div'); d.className='link-item'; d.appendChild(a); container.appendChild(d)
        })
      })
    }

    // Inits
    await listFiles()
    await initCalendar()
    renderLinks()
  </script>
</body>
</html>
